<div class="container">
    <form id="controlData">
        <div class="form-group row">
            <label for="NodeId" class="col-sm-2 col-form-label">Cubicle</label>
            <div class="col-sm-10">
                <select class="form-control" name="NodeId" id="NodeId" data-bind="options: fm.data(),value:'vm.activeElement().formData().NodeId',optionsText: 'NodeName',optionsValue: 'NodeId'"></select>
            </div>
            <input type="hidden" name="NodeName" id="NodeName" bind="value:vm.activeElement().formData().NodeName">
        </div>
    </form>
</div>
<script>
    var selectEl = $fg('#NodeId'),
        nameHdnEl = $fg('#NodeName'),
        update = farmGraphModule.elements.elementModal.selector.data('update'),
        typeId = farmGraphModule.elements.elementModal.selector.data('type')
    link = '/Content/LocationItemEdit.aspx';

    farmGraphModule.farmDb.GetNodeItems(typeId, function (response) {
        if (response == null) return;
        fm = new formNodeModel();
        fm.data(response)
        ko.applyBindings(formNodeModel, document.getElementById('controlData'));
    })

    var selectedOption = selectEl.find('option:selected');
    setNodeElement(selectedOption);

    selectEl.change(function (e) {
        var option = $fg(this).find('option:selected');
        setNodeElement(option);
    })

    function setNodeElement(option) {

        var exParams = createQueryParams({
            type: typeId
        })

        if (update) {
            link = '/Content/LocationItemEdit.aspx';
            farmGraphModule.redirectForm(link, exParams)
            return;
        }

        if (option.length == 0) {
            farmGraphModule.redirectForm(link, exParams)
            return;
        }

        fm.newNodeId(option.val());
        fm.newNodeName(option.text())
        nameHdnEl.val(option.text());
    }
</script>