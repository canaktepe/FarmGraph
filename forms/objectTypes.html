<div class="row">
    <div class="col">
        <h5 class="border border-primary border-top-0 border-right-0 border-left-0"> Devices</h5>
        <div class="form type-form" data-bind="foreach:devices">
            <div class="form-check">
                <input class="form-check-input" data-bind="value:$data.id() ,attr: { id:'chk_' + $data.id()},enable:$data.status()"
                    type="radio" name="farmCheckBox">
                <label class="form-check-label" data-bind="text:$data.name(),attr: { for:'chk_'+ $data.id() }"></label>
            </div>
        </div>
    </div>
    <div class="col">
        <h5 class="border border-success border-top-0 border-right-0 border-left-0">Physicals</h5>
        <div class="form type-form" data-bind="foreach:physicals">
            <div class="form-check">
                <input class="form-check-input" data-bind="value:$data.id() ,attr: { id:'chk_' + $data.id()},enable:$data.status()"
                    type="radio" name="farmCheckBox">
                <label class="form-check-label" data-bind="text:$data.name(),attr: { for:'chk_'+ $data.id() }"></label>
            </div>
        </div>
    </div>
    <div class="col">
        <h5 class="border border-danger border-top-0 border-right-0 border-left-0">Objects</h5>
        <div class="form type-form" data-bind="foreach:objects">
            <div class="form-check">
                <input class="form-check-input" data-bind="value:$data.id() ,attr: { id:'chk_' + $data.id()},enable:$data.status()"
                    type="radio" name="farmCheckBox">
                <label class="form-check-label" data-bind="text:$data.name(),attr: { for:'chk_'+ $data.id() }"></label>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {

        var jsonData = JSON.parse(localStorage.getItem('JSONData')) || [];
        if (jsonData.length > 0) {
            jsonData = jsonData.map(function (item) {
                return new farmGraphModule.jsonToModel(item);
            })
        }

        var viewModel = function () {
            var self = this;

            self.devices = ko.observableArray([]);
            self.physicals = ko.observableArray([]);
            self.objects = ko.observableArray([]);
            self.createdElements = ko.observableArray(jsonData);
            self.activeElement = ko.observable(null);
            self.selectedRoutingElement = ko.observable(null);
            self.searchElementKeyword = ko.observable('');
            self.filteredCreatingElementsByRoutable = ko.observableArray([]);

            self.addRouting = function () {
                if (!self.activeElement() || !self.selectedRoutingElement()) return;
                // self.getCreatedElement(self.activeElement().guid, function (item) {
                var route = { guid: self.selectedRoutingElement().guid, name: self.selectedRoutingElement().formData().Name };
                // item.routing.push(route);
                self.activeElement().routing.push(route)
                localStorage.setItem('JSONData', ko.toJSON(self.createdElements()))
                // })
                self.selectedRoutingElement(null);
            }

            self.addRoutingCallback = function (elem) {
                if (elem.nodeType === 1) {
                    $(elem)
                        .animate({ backgroundColor: '#fc9c9c' }, 200)
                        .animate({ backgroundColor: 'transparent' }, 800);
                }
            }

            self.hasRoutingList = function (data) {
                if (self.activeElement()) {
                //    var a=  ko.utils.arrayFirst(data, function (item) {
                //      return  ko.utils.arrayFilter(self.activeElement().routing(),function(route){
                //          console.log(route);
                //            return item == route;
                //        })
                //     })

                   
                //     return a == null;
                return true;
                }
            }

            self.selectRoutingElement = function (data) {
                self.selectedRoutingElement(data);
            }

            self.deleteRouting = function (item) {
                self.activeElement().routing.remove(item);
                localStorage.setItem('JSONData', ko.toJSON(self.createdElements()))
            }

            self.RoutingSelectableElements = ko.computed(function () {
                self.filteredCreatingElementsByRoutable([])
                var filter = self.searchElementKeyword();
                self.createdElements().some(function iter(o, i, a) {
                    if (o !== self.activeElement()) {
                        self.filteredCreatingElementsByRoutable.push(o)
                    }
                    var children = (typeof o.children) === "function" ? o.children() : o.children
                    return children && children.some(iter);
                });

                if (filter) {
                    self.filteredCreatingElementsByRoutable(ko.utils.arrayFilter(self.filteredCreatingElementsByRoutable(), function (item) {
                        return item.formData().Name.indexOf(filter) > -1;
                    }))
                }
            })

            self.getActiveElementRouting = ko.computed({
                read: function () {
                    var active = self.activeElement();
                    if (active) {
                        var data = $.extend([], active.routing())
                        return data.reverse();
                    }
                    else {
                        return ko.observableArray([]);
                    }
                }
            })

            self.getActiveElement = ko.pureComputed({
                read: function () {
                    return self.activeElement() ? self.activeElement() : { name: "Not Selected", position: ko.observable({ x: 0, y: 0, w: 0, h: 0 }) };
                },
                write: function () {
                    self.activeElement().position({
                        x: parseInt(self.activeElement().position().x),
                        y: parseInt(self.activeElement().position().y),
                        w: parseInt(self.activeElement().position().w),
                        h: parseInt(self.activeElement().position().h)
                    })
                    // self.activeElement().position.x = parseInt(self.activeElement().position.x);
                    // self.activeElement().position.y = parseInt(self.activeElement().position.y);
                    // self.activeElement().position.w = parseInt(self.activeElement().position.w);
                    // self.activeElement().position.h = parseInt(self.activeElement().position.h);

                    //set canvas element position
                    $("div[id=" + self.activeElement().guid() + "]").css({
                        width: self.activeElement().position.w,
                        height: self.activeElement().position.h,
                        top: self.activeElement().position.y,
                        left: self.activeElement().position.x,
                    })
                    localStorage.setItem('JSONData', ko.toJSON(self.createdElements()))
                }
            }, viewModel)

            self.setElementPosition = function (pos) {
                self.getActiveElement().position({
                    x: typeof (pos.left) == 'number' ? pos.left : self.getActiveElement().position().x,
                    y: typeof (pos.top) == 'number' ? pos.top : self.getActiveElement().position().y,
                    w: typeof (pos.width) == 'number' ? pos.width : self.getActiveElement().position().w,
                    h: typeof (pos.height) == 'number' ? pos.height : self.getActiveElement().position().h,
                })
            }

            self.setEnable = function (acceptable) {
                var data = self.devices().concat(self.physicals()).concat(self.objects());
                ko.utils.arrayForEach(data, function (el) {
                    ko.utils.arrayFilter(acceptable, function (acc) {
                        if (acc == el.id()) {
                            el.status(true);
                        }
                    });
                })
                return true;
            }

            self.deleteElement = function (item) {
                var elem = self.activeElement();
                if (elem) {
                    self.createdElements().some(function iter(o, i, a) {
                        if (o.guid() === elem.guid()) {
                            a.splice(i, 1);
                            $("div[id=" + elem.guid() + "]").remove();
                            self.activeElement(null)
                            localStorage.setItem('JSONData', ko.toJSON(self.createdElements()))
                            return true;
                        }
                        var children = (typeof o.children) === "function" ? o.children() : o.children
                        return children && children.some(iter);
                    });
                }
            }

            self.setDisableAllTypes = function () {
                var data = self.devices().concat(self.physicals()).concat(self.objects());
                ko.utils.arrayForEach(data, function (el) {
                    el.status(false);
                })
                $('input[name="farmCheckBox"]').prop('checked', false);
            }

            self.getTypeOptions = function (id) {
                if (!id) return;
                var data = self.devices().concat(self.physicals()).concat(self.objects());
                // data = $.extend([], data)
                var el = ko.utils.arrayFirst(data, function (type) {
                    // var item = $.extend({}, new farmGraphModule.jsonToModel(ko.toJS(type)));
                    // if (item.id() == id)
                    // return item;
                    return type.id() == id;
                });
                // el.children = ko.observableArray([]);
                // el.routing = ko.observableArray([]);
                // return $.extend({}, el);;
                return el;
            }

            self.loadFarmElements = function () {
                ko.utils.arrayForEach(farmGraphModule.elements.jsonElements.devices, function (el) {
                    // obj.status = ko.observable(false);
                    self.devices.push($.extend(true, {}, new farmGraphModule.jsonToModel(el)))
                })
                ko.utils.arrayForEach(farmGraphModule.elements.jsonElements.physicals, function (el) {
                    // obj.status = ko.observable(false);
                    self.physicals.push($.extend(true, {}, new farmGraphModule.jsonToModel(el)))
                })
                ko.utils.arrayForEach(farmGraphModule.elements.jsonElements.objects, function (el) {
                    // obj.status = ko.observable(false);
                    self.objects.push($.extend(true, {}, new farmGraphModule.jsonToModel(el)))
                })
            }

            self.pushElement = function (parentGuid, element) {
                var newElement = new farmGraphModule.jsonToModel(ko.toJS(element));
                if (parentGuid == null)
                    self.createdElements.push(newElement);

                self.getCreatedElement(parentGuid, function (data) {
                    data.children.push(newElement);
                })
                localStorage.setItem('JSONData', ko.toJSON(self.createdElements()))
            }

            self.getCreatedElement = function (guid, callback) {
                if (!guid) return;
                self.createdElements().some(function iter(o, i, a) {
                    if (o.guid() === guid) {
                        callback(o)
                    }
                    var children = (typeof o.children) === "function" ? o.children() : o.children
                    return children && children.some(iter);
                });
            }

            self.setElement = function (option) {
                self.getCreatedElement(option.guid(), function (callback) {
                    callback.formData(option.formData());
                    localStorage.setItem('JSONData', ko.toJSON(self.createdElements()))
                })
            }

            self.selectElement = function (guid) {
                if (!guid) return;
                self.getCreatedElement(guid, function (item) {
                    self.activeElement(item)
                })
            }

            self.loadFarmElements();
        }

        vm = new viewModel();
        ko.applyBindings(vm);
    })
</script>